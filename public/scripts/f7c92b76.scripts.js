"use strict";angular.module("clientApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ui.bootstrap","growlNotifications"]).config(["$routeProvider","$httpProvider",function(a,b){b.interceptors.push("AuthIntercept"),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/delivery",{templateUrl:"views/delivery.html",controller:"DeliveryCtrl"}).when("/restaurateurs",{templateUrl:"views/restaurateursList.html",controller:"RestaurateursCtrl"}).when("/restaurateurs/:id",{templateUrl:"views/restaurateur.html",controller:"RestaurateursCtrl"}).when("/restaurants",{templateUrl:"views/restaurantList.html",controller:"RestaurantCtrl"}).when("/restaurants/:id",{templateUrl:"views/restaurant.html",controller:"RestaurantCtrl"}).when("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/orderUp",{templateUrl:"views/clientorder.html",controller:"ClientOrderCtrl"}).when("/orders/:id?",{templateUrl:"views/orders.html",controller:"OrdersCtrl"}).when("/menus/:id?/:restaurant?",{templateUrl:"views/menu.html",controller:"MenuCtrl"}).otherwise({templateUrl:"views/404.html"})}]).run(["$rootScope","AuthService","$route","$location","$q","$animate",function(a,b,c,d,e,f){f.enabled(!0);var g=b.getAuthData();a.$on("$routeChangeStart",function(a,f){e.when(g).then(function(){b.isAuthenticated()?b.isAuthRoute(f.originalPath)&&(c.reload(),d.path("/")):b.isAuthRoute(f.originalPath)||(c.reload(),d.path("/login"))})})}]),angular.module("clientApp").controller("MainCtrl",["$scope","$location","AuthService",function(a,b,c){function d(){a.loading=!1,c.isAuthenticated()?a.UserInfo=c.currentUser():b.path("login")}a.loading=!0,console.log("MainCtrl call"),a.tagLine=function(){if(!c.isAuthenticated())return"Why, hello there. You aren't supposed to be here, yet you have made your way one way or another. Please wait while monkeys bring back your signal";switch(a.UserInfo.type){case"Client":return"Delicious meals at your fingertips.";case"Livreur":return"Someone's got the need for feed";case"Restaurateur":return"The entire world at your fingertips";case"Entrepreneur":return"JOHN CONNOR HAS NOT YET BEEN LOCATED"}},d()}]),angular.module("clientApp").controller("LoginCtrl",["$scope","AuthService","$location",function(a,b,c){a.errors=[],a.authenticate=function(){a.errors=[],b.authenticate(a.login).then(function(){c.path("main")},function(){a.errors.push({which:"email"}),a.errors.push({which:"password"})})},a.hasError=function(b){return _.some(a.errors,{which:b})},a.clearError=function(b){a.errors=_.without(a.errors,{which:b})}}]),angular.module("clientApp").controller("HeaderCtrl",["$scope","$location","AuthService",function(a,b,c){function d(){c.logout().then(function(){b.path("login")})}function e(){var b=c.currentUser();switch(b.type){case"Client":a.menuItems=[{location:"/orderUp",name:"Place Order"},{location:"/account",name:"Account Control"}].concat(f);break;case"Livreur":a.menuItems=[{location:"/delivery",name:"Prendre Livraison"}].concat(f);break;case"Entrepreneur":a.menuItems=[{location:"/restaurateurs",name:"Gérer Restaurateurs"},{location:"/restaurants",name:"Gérer Restaurants"}].concat(f);break;case"Restaurateur":a.menuItems=[{location:"/orders",name:"Prendre une Commande",badge:3},{location:"/menus",name:"Gérer Menus"}].concat(f);break;default:a.menuItems=[{location:"/login",name:"Login"},{location:"/signup",name:"Create New Account"}]}}a.$watch(c.currentUser,function(a){e(a)});var f=[{callback:d,name:"Logout"}];a.menuItems=[],a.isActive=function(a){return a===b.path()},a.itemLocation=function(a){return a.location?"#"+a.location:""},e()}]),angular.module("clientApp").factory("AuthService",["$q","$location","$window","$http","growlNotifications","TokenHandler",function(a,b,c,d,e,f){function g(a){switch(a){default:return["/login","/signup"]}}function h(a){return a?d({method:"POST",url:k,data:a}):void 0}var i={},j=!1,k="/api/tokens",l=function(b,c){var d=a.defer();return b.token=c,i=b,m.set(i).then(d.resolve),d.promise},m={get:function(){var b=a.defer();return b.resolve(JSON.parse(sessionStorage.getItem("restaurminator-userdata")||"{}")),b.promise},set:function(b){var c=a.defer();return sessionStorage.setItem("restaurminator-userdata",JSON.stringify(b)),c.resolve(null),c.promise}};return{isAuthenticated:function(){return!_.isUndefined(i.id)&&0!==i.id},requireLogin:function(){var c=a.defer(),d=this;return this.getAuthData().then(function(){d.isAuthenticated()||b.path("login"),c.resolve()}),c.promise},isAuthRoute:function(a){return-1!==_.indexOf(g(),a)},currentUser:function(){return i},authenticate:function(b){var c=a.defer();return a.when(h(b)).then(function(b){f.set(b.data.token),a.when(l(b.data.user,b.data.token)).then(c.resolve)},function(a){_.each(a.data.errors,function(a){e.add(a.message,"danger")}),c.reject()}),c.promise},destroyToken:function(){f.destroy()},logout:function(){var b=a.defer();return i={},this.destroyToken(),a.when(m.set({})).then(b.resolve),b.promise},getAuthData:function(){var b=a.defer();return j?b.resolve(i):(j=!0,a.when(m.get()).then(function(a){i=a,b.resolve(i)})),b.promise}}}]),angular.module("clientApp").controller("SignupCtrl",["$scope","Client","$location","AuthService",function(a,b,c){var d=a.currentClient=new b;a.currentAddress={},a.register=function(){d.user.addresses=[a.currentAddress],d.$save().then(function(){c.path("/login")})}}]),angular.module("clientApp").controller("DeliveryCtrl",["$scope","Livraison","CurrencyFormatter","DateFormatter","AddressFormatter","$modal",function(a,b,c,d,e,f){a.livraisons=b.all();var g=(a.capitalize=function(a){return a?a[0].toUpperCase()+a.substring(1):""},a.statusClass=function(a){switch(a){case"complete":return"success";case"ready":return"warning";case"delivering":return"danger";default:return"default"}});a.statusLabelClass=function(a){return"label-"+g(a)},a.deliverySelected=function(){return a.selectedDelivery&&!_.isEmpty(a.selectedDelivery)},a.subtotal=function(a){return a?_.reduce(a.repas,function(a,b){return a+c.filterFloat(b.subtotal)},0):0},a.finalTotal=function(b){var c=a.subtotal(b);return c+a.taxes(c)},a.currency=c.currency,a.address=e.address,a.date=d.datetime,a.taxes=c.taxes,a.total=function(a){return 1.15*c.filterFloat(a)},a.selectDelivery=function(b){a.selectedDelivery=b},a.startDelivery=function(a){a.$$update({status:"delivering"})},a.finishDelivery=function(a){a.$$update({status:"complete"})},a.getDirections=function(a){f.open({template:'<map type="roadmap" destination="'+e.address(a.address)+'"></map>'})}}]),angular.module("clientApp").controller("RestaurateursCtrl",["$scope","$routeParams","Restaurateur","AddressFormatter","Restaurant",function(a,b,c,d,e){a.selectedRestaurants={},b.id?("new"==b.id?a.currentRestaurateur=new c:(a.currentRestaurateur=c.get({id:b.id}),a.currentRestaurateur.$promise.then(function(){a.selectedRestaurants=_.zipObject(_.pluck(a.currentRestaurateur.restaurants,"id"),_.map(a.currentRestaurateur.restaurants,function(){return!0}))})),a.currentRestaurateur.restaurants=_.pluck(a.currentRestaurateur.restaurants,"id"),a.restaurants=e.all()):a.restaurateurs=c.all(),a.confirmRestaurateur=function(){var b=a.currentRestaurateur.id?"$$update":"$save";a.currentRestaurateur.user={name:a.currentRestaurateur.name},a.currentRestaurateur.user.restaurants=_.compact(_.map(a.selectedRestaurants,function(a,b){return a?b:void 0})),a.currentRestaurateur[b]()},a.restoIsSelected=function(b){return _.find(a.currentRestaurateur.restaurants,{id:b.id})},a.address=d.address,a.restaurantList=function(a){var b=a.restaurants;return _.isEmpty(b)&&(b=[{name:"( No restaurants assigned )"}]),_.pluck(b,"name").join(", ")}}]),angular.module("clientApp").service("Cart",function(){}),angular.module("clientApp").directive("passwordVerify",function(){return{require:"ngModel",scope:{passwordVerify:"="},link:function(a,b,c,d){a.$watch(function(){var b;return(a.passwordVerify||d.$viewValue)&&(b=a.passwordVerify+"_"+d.$viewValue),b},function(b){b&&d.$parsers.unshift(function(b){var c=a.passwordVerify;return c!==b?void d.$setValidity("passwordVerify",!1):(d.$setValidity("passwordVerify",!0),b)})})}}}),angular.module("clientApp").controller("AccountCtrl",["$scope","Client","$routeParams","$location","AddressFormatter","AuthService",function(a,b,c,d,e,f){a.address=e.userAddress,a.currentClient=b.get({id:f.currentUser().id}),a.saveChanges=function(){console.log(a.currentClient),a.currentClient.$$update()},a.addAddress=function(b){b.id=void 0,a.currentClient.user.addresses.push(b),a.currentAddress=b},a.newAddress=function(){return!_.has(a.currentAddress,"id")}}]),angular.module("clientApp").controller("ClientOrderCtrl",["$scope","$location","RestaurantMenu","Restaurant","CurrencyFormatter","Client","AuthService","AddressFormatter","growlNotifications","Commande",function(a,b,c,d,e,f,g,h,i,j){a.selectedRestaurant,a.currentOrder={},a.stepReady=[],a.stepReady[1]=!0,a.restaurants=d.all(),a.currentClient=f.get({id:g.currentUser().id}),a.currentClient.$promise.then(function(){a.currentAddress=_.find(a.currentClient.addresses,{is_default:!0})});var k=function(){},l=function(){};a.stepReady=function(b){return b>1&&!a.selectedRestaurant?!1:b>2&&a.emptyOrder()?!1:b>3&&_.isEmpty(a.currentAddress)?!1:b>4&&!a.deliveryDate?!1:!0},a.confirmOrder=function(){if(!a.stepReady(5))return!1;var c=new j;c.repas=_.map(a.currentOrder,function(a,b){return{repas_id:b,quantity:a}}),c.restaurant=a.selectedRestaurant,c.client=g.currentUser().id,c.scheduled_date=a.deliveryDate,c.address=a.currentAddress.id,c.$save().then(function(a){i.add("Your order has successfully been placed. Your order confirmation number is "+a.id,"success"),b.path("/")})},a.showStep=function(b){a.stepReady(b)&&(a.currentStep=b||1)},a.nextStep=function(b){if(_.isUndefined(b)||b){var c=a.currentStep;a.showStep(c+1)}},a.emptyOrder=function(){return _.isEmpty(a.currentOrder)},a.selectRestaurant=function(b){a.selectedRestaurant=b,a.currentOrder={},k(),a.menus=c.allFor({restaurant_id:b}),a.menus.$promise.then(function(){l(),a.nextStep()})},a.selectAddress=function(b){a.currentAddress=b},a.incrementRepas=function(b){_.isUndefined(a.currentOrder[b.id])&&(a.currentOrder[b.id]=0),a.currentOrder[b.id]+=1},a.decrementRepas=function(b){a.currentOrder[b.id]&&a.currentOrder[b.id]>0&&(a.currentOrder[b.id]-=1,0==a.currentOrder[b.id]&&delete a.currentOrder[b.id])},a.getCurrentRepasCount=function(b){return a.currentOrder[b.id]||0};var m=a.getRepasProp=function(b,c){return b=_.parseInt(b),_(a.menus).pluck("repas").flatten().find({id:b})[c]};a.getRepasName=function(a){return m(a,"nom")},a.getRepasDescription=function(a){return m(a,"description")},a.getRowSubtotalFloat=function(a,b){return e.filterFloat(m(a,"prix"))*b},a.getRowSubtotal=function(b,c){return e.currency(a.getRowSubtotalFloat(b,c))},a.getSubtotalFloat=function(){return _.reduce(a.currentOrder,function(b,c,d){return b+a.getRowSubtotalFloat(d,c)},0)},a.getSubtotal=function(b){return e.currency(a.getSubtotalFloat(b))},a.getTaxesFloat=function(b){return e.taxes(a.getSubtotalFloat(b))},a.getTaxes=function(b){return e.currency(a.getTaxesFloat(b))},a.getTotal=function(b){return e.currency(a.getTaxesFloat(b)+a.getSubtotalFloat(b))},a.currency=e.currency,a.address=h.address}]),angular.module("clientApp").controller("RestaurantCtrl",["$scope","$location","$routeParams","Restaurant","AddressFormatter","Restaurateur",function(a,b,c,d,e,f){c.id?(a.currentRestaurant="new"==c.id?new d:d.get({id:c.id}),a.restaurateurs=f.all()):a.restaurants=d.all(),a.address=e.address,a.saveRestaurant=function(){a.currentRestaurant.id?a.currentRestaurant.$$update().then(function(){b.path("/restaurants")}):a.currentRestaurant.$save().then(function(){b.path("/restaurants")})},a.defaultRestaurateur=function(){return a.currentRestaurant.restaurateur_id?"-- Restaurateur: "+a.currentRestaurant.restaurateur_name+" --":"-- Choose a Restaurateur --"}}]),angular.module("clientApp").controller("OrdersCtrl",["$scope","Commande","RestaurateurCommande","AddressFormatter","CurrencyFormatter","DateFormatter",function(a,b,c,d,e,f){a.restaurantOrders=c.all();var g=(a.capitalize=function(a){return a?a[0].toUpperCase()+a.substring(1):""},a.statusClass=function(a){switch(a){case"ready":return"success";case"ordered":return"warning";case"cancelled":return"danger";default:return"default"}});a.currency=e.currency,a.address=d.address,a.date=f.datetime,a.taxes=e.taxes,a.total=function(a){return 1.15*e.filterFloat(a)},a.statusLabelClass=function(a){return"label-"+g(a)},a.selectOrder=function(b){a.currentOrder=b},a.orderSelected=function(){return a.currentOrder&&!_.isEmpty(a.currentOrder)},a.subtotal=function(a){return a?_.reduce(a.repas,function(a,b){return a+e.filterFloat(b.subtotal)},0):0},a.finalTotal=function(b){var c=a.subtotal(b);return c+a.taxes(c)},a.startPrep=function(c){b.$update({id:c.id,status:"preparing"}).$promise.then(function(){_.find(a.restaurantOrders,function(a){return _.find(a.commandes,{id:c.id})}).$get()}),a.currentOrder=null},a.finishPrep=function(c){b.$update({id:c.id,status:"ready"}).$promise.then(function(){_.find(a.restaurantOrders,function(a){return _.find(a.commandes,{id:c.id})}).$get()}),a.currentOrder=null}}]),angular.module("clientApp").factory("AuthIntercept",["$q","$location","TokenHandler",function(a,b,c){return{request:function(a){return a=a||{},a.headers.Authorization=c.get(),a},responseError:function(d){return 401===d.status&&_.find(d.data.errors,{type:"UnauthorizedError"})&&(c.destroy(),b.path("login")),a.reject(d)}}}]),angular.module("clientApp").factory("TokenHandler",function(){var a="";return{set:function(b){a=b},destroy:function(){a=""},get:function(){return a}}}),angular.module("clientApp").controller("MenuCtrl",["$scope","Menu","$routeParams","$location",function(a,b,c,d){a.currentMenu={},a.currentRepas={},c.id?"new"!==c.id?a.currentMenu=b.get({id:c.id}):(a.currentMenu=new b,a.currentMenu.repas=[{isPlaceholder:!0,nom:"Please add a meal"}],a.currentMenu.restaurant_id=c.restaurant):b.getOwn({},function(b){a.menus=_.groupBy(b,"restaurant_id")});var e=function(a){return/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(a)?Number(a):0/0},f=function(b){var c=_.clone(b);a.currentMenu.repas=a.currentMenu.repas||[],a.currentMenu.repas.push(c)},g=function(a,b){_.extend(a,b)},h=function(){_.remove(a.currentMenu.repas,function(a){return a.isPlaceholder})};a.addOrModifyRepas=function(b){h();var c=_.findWhere(a.currentMenu.repas,{nom:b.nom});c?g(c,b):f(b)},a.emptyMenu=function(){return!a.currentMenu.repas||a.currentMenu.repas&&!a.currentMenu.repas.length},a.setCurrentRepas=function(b){b.isPlaceholder||(a.currentRepas=_.clone(b),a.currentRepas.prix=e(b.prix))},a.confirmMenu=function(){var b;console.log(a.currentMenu),b=a.currentMenu.id?a.currentMenu.$$update():a.currentMenu.$save(),b.then(d.path("/menus"))},a.modifyingMenu=function(){return!_.isUndefined(c.id)},a.currentMenuRepas=function(){return _.isEmpty(a.currentMenu.repas)?[{isPlaceholder:!0,nom:"Please add a meal to the menu"}]:a.currentMenu.repas}}]),angular.module("clientApp").factory("Menu",["$resource","AuthService",function(a,b){var c=a("/api/menus/:id",{id:"@id"},{getOwn:{method:"GET",params:{"filter_by[restaurateur]":b.currentUser().id},isArray:!0},get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return c}]),angular.module("clientApp").factory("Client",["$resource",function(a){var b=a("/api/clients/:id",{id:"@id"},{get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return b}]),angular.module("clientApp").factory("Restaurant",["$resource","AuthService",function(a){var b=a("/api/restaurants/:id",{id:"@id"},{get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return b}]),angular.module("clientApp").factory("AddressFormatter",function(){var a=function(a){var a=a||{},b=[a.street_address,a.city,a.province,a.country,a.postal_code];return _.compact(b).join(", ")},b=function(b){return a(b)+(b.is_default?" [Default]":"")};return{address:a,userAddress:b}}),angular.module("clientApp").factory("Restaurateur",["$resource","AuthService",function(a){var b=a("/api/restaurateurs/:id",{id:"@id"},{get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return b}]),angular.module("clientApp").factory("RestaurantMenu",["$resource",function(a){var b=a("/api/restaurants/:restaurant_id/menus/:id",{id:"@id",restaurant_id:"@restaurant_id"},{get:"GET",allFor:{method:"GET",isArray:!0},all:{method:"GET",isArray:!0,url:"/api/menus"},put:{method:"PUT"},$update:{method:"PUT"}});return b}]),angular.module("clientApp").factory("CurrencyFormatter",function(){var a=function(a){return/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(a)?Number(a):0/0},b=function(a){return a.toFixed(2)},c=function(c,d){var e=a(c);return _.isNaN(e)?d||"N/A":b(e)+" $"},d=function(b){return b=a(b),.15*b};return{currency:c,filterFloat:a,taxes:d}}),angular.module("clientApp").factory("Commande",["$resource",function(a){var b=a("/api/commandes/:id",{id:"@id"},{get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return b}]),angular.module("clientApp").factory("RestaurateurCommande",["$resource","AuthService",function(a,b){var c=a("/api/restaurants/:id/commandes/",{restaurateur_id:b.currentUser().id,id:"@id"},{all:{method:"GET",isArray:!0},get:"GET"});return c}]),angular.module("clientApp").factory("DateFormatter",function(){var a=_.memoize(function(a){return new Date(a)}),b=function(a,b){var c=""+a;return c.length<b&&(c="0"+c),c},c=function(b){var c=a(b);return c.getFullYear()+"-"+c.getMonth()+"-"+c.getDate()},d=function(c){var d=a(c);return b(d.getHours(),2)+":"+b(d.getMinutes(),2)};return{datetime:function(a){return c(a)+" "+d(a)},date:c,time:d}}),angular.module("clientApp").factory("Livraison",["$resource","AuthService",function(a,b){var c=a("/api/livraisons/:id",{id:"@id",livreur_id:b.currentUser().id},{get:"GET",all:{method:"GET",isArray:!0},put:{method:"PUT"},$update:{method:"PUT"}});return c}]),angular.module("clientApp").directive("map",function(){var a,b,c,d,e=new google.maps.DirectionsRenderer,f=new google.maps.DirectionsService,g=new google.maps.Geocoder;return c={restrict:"EAC",scope:{destination:"@",markerContent:"@",zoom:"=",type:"@",directions:"@"},replace:!0,template:'<form novalidate name="mapContainer" class="well mapContainer"><div id="theMap"></div><div class="directions" ng-show="directions || directions==undefined"><label>Origin:</label><input class="form-control" type="text" ng-model="origin" name="origin"  required><small class="error" id="wrongAddress">Error: \n <span>Sorry this is not a valid address.</span></small><label>Destination:</label><input class="form-control" ng-model="endPoint" type="text" disabled><br><button class="getDirections btn btn-primary" ng-click="getDirections()" ng-disabled="mapContainer.$invalid">Get Directions</button> <button class="clearDirections btn btn-secondary" ng-click="clearDirections()" ng-disabled="mapContainer.$invalid">Clear</button><div id="directionsList"></div></div></form>',link:function(c){c.init=function(){var e={zoom:void 0!==c.zoom?c.zoom:15,mapTypeId:c.type.toLowerCase(),streetViewControl:!1};a=new google.maps.Map(document.getElementById("theMap"),e),c.endPoint=void 0!==c.destination?c.destination:"1600 Amphitheatre Parkway, Santa Clara County, CA",g.geocode({address:c.endPoint},function(e,f){var g=e[0].geometry.location;f===google.maps.GeocoderStatus.OK?(a.setCenter(g),b=new google.maps.Marker({map:a,position:g,animation:google.maps.Animation.DROP}),d=new google.maps.InfoWindow({content:void 0!==c.markerContent?c.markerContent:"Google HQ"}),google.maps.event.addListener(b,"click",function(){return d.open(a,b)})):alert("Cannot Geocode")})},c.init(),c.getDirections=function(){var b={origin:c.origin,destination:c.endPoint,travelMode:google.maps.DirectionsTravelMode.DRIVING};f.route(b,function(a,b){b===google.maps.DirectionsStatus.OK?(e.setDirections(a),document.getElementById("wrongAddress").style.display="none"):document.getElementById("wrongAddress").style.display="block"}),e.setMap(a),e.setPanel(document.getElementById("directionsList"))},c.clearDirections=function(){c.init(),e.setPanel(null),c.origin=""}}}});